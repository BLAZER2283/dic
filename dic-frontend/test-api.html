<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API</title>
</head>
<body>
    <h1>Test DIC Analysis API</h1>

    <h2>Test GET request</h2>
    <button onclick="testGet()">Test GET /api/analyses/</button>
    <div id="getResult"></div>

    <h2>Test CSRF Token</h2>
    <button onclick="testCSRF()">Test CSRF Token</button>
    <div id="csrfResult"></div>

    <h2>Test Simple POST</h2>
    <button onclick="testSimplePost()">Test Simple POST /api/test-create/</button>
    <div id="simplePostResult"></div>

    <h2>Test POST request</h2>
    <form id="analysisForm" enctype="multipart/form-data">
        <label>Name: <input type="text" name="name" value="Test Analysis" required></label><br>
        <label>Image Before: <input type="file" name="image_before" accept="image/*" required></label><br>
        <label>Image After: <input type="file" name="image_after" accept="image/*" required></label><br>
        <label>Subset Size: <input type="number" name="subset_size" value="25"></label><br>
        <label>Step: <input type="number" name="step" value="12"></label><br>
        <label>Max Iter: <input type="number" name="max_iter" value="35"></label><br>
        <label>Min Correlation: <input type="number" name="min_correlation" value="0.4" step="0.01"></label><br>
        <button type="button" onclick="testPost()">Create Analysis</button>
    </form>
    <div id="postResult"></div>

    <script>
        async function testGet() {
            try {
                console.log('Testing GET request...');
                const response = await fetch('/api/analyses/');
                const data = await response.json();
                console.log('GET response:', response.status, data);
                document.getElementById('getResult').innerHTML = `
                    <p>Status: ${response.status}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('GET error:', error);
                document.getElementById('getResult').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        async function testCSRF() {
            try {
                console.log('Testing CSRF token retrieval...');
                const response = await fetch('/api/get-csrf-token/');
                const data = await response.json();
                console.log('CSRF response:', response.status, data);
                document.getElementById('csrfResult').innerHTML = `
                    <p>Status: ${response.status}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('CSRF error:', error);
                document.getElementById('csrfResult').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        async function testSimplePost() {
            try {
                console.log('Testing simple POST request...');
                const formData = new FormData();
                formData.append('name', 'Test Analysis');
                formData.append('test', 'value');

                const response = await fetch('/api/test-create/', {
                    method: 'POST',
                    body: formData
                });

                console.log('Simple POST response status:', response.status);
                const responseText = await response.text();
                console.log('Simple POST response text:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = responseText;
                }

                document.getElementById('simplePostResult').innerHTML = `
                    <p>Status: ${response.status}</p>
                    <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
                `;

            } catch (error) {
                console.error('Simple POST error:', error);
                document.getElementById('simplePostResult').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        async function testPost() {
            try {
                console.log('Testing POST request...');
                const form = document.getElementById('analysisForm');
                const formData = new FormData(form);

                console.log('Simple POST FormData contents:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                // Check if CSRF token is included
                const hasCsrf = Array.from(formData.entries()).some(([key]) => key === 'csrfmiddlewaretoken');
                console.log('Simple POST FormData has CSRF token:', hasCsrf);

                // Check if CSRF token is included
                const hasCsrf = Array.from(formData.entries()).some(([key]) => key === 'csrfmiddlewaretoken');
                console.log('FormData has CSRF token:', hasCsrf);

                const response = await fetch('/api/analyses/', {
                    method: 'POST',
                    body: formData
                });

                console.log('POST response status:', response.status);
                const responseText = await response.text();
                console.log('POST response text:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = responseText;
                }

                document.getElementById('postResult').innerHTML = `
                    <p>Status: ${response.status}</p>
                    <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
                `;

            } catch (error) {
                console.error('POST error:', error);
                document.getElementById('postResult').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
