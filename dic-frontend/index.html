<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DIC Analyzer</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div id="app">
      <h1 style="color: #1976D2; text-align: center; margin-bottom: 30px;">DIC Analyzer</h1>

      <!-- Navigation -->
      <nav style="background: #f5f5f5; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
        <button @click="currentView = 'create'" :style="{margin: '0 10px', padding: '8px 16px', background: currentView === 'create' ? '#1976D2' : '#666', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer'}">
          New Analysis
        </button>
        <button @click="currentView = 'list'" :style="{margin: '0 10px', padding: '8px 16px', background: currentView === 'list' ? '#1976D2' : '#666', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer'}">
          All Analyses
        </button>
        <button v-if="!isAuthenticated" @click="currentView = 'login'" :style="{margin: '0 10px', padding: '8px 16px', background: currentView === 'login' ? '#1976D2' : '#666', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer'}">
          Login
        </button>
        <button v-if="!isAuthenticated" @click="currentView = 'register'" :style="{margin: '0 10px', padding: '8px 16px', background: currentView === 'register' ? '#1976D2' : '#666', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer'}">
          Register
        </button>
        <button v-if="isAuthenticated" @click="logout" style="margin: '0 10px', padding: '8px 16px', background: '#f44336', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer'">
          Logout
        </button>
        <span v-if="isAuthenticated" style="margin-left: 20px; color: #666;">
          Welcome, {{ user.username }}!
        </span>
      </nav>

      <!-- Login View -->
      <div v-if="currentView === 'login'">
        <h2>Login</h2>
        <form @submit.prevent="login" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
            <input
              v-model="loginForm.username"
              type="text"
              required
              style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
            />
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
            <input
              v-model="loginForm.password"
              type="password"
              required
              style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
            />
          </div>
          <button
            type="submit"
            :disabled="authLoading"
            style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%;"
          >
            {{ authLoading ? 'Logging in...' : 'Login' }}
          </button>
        </form>
      </div>

      <!-- Register View -->
      <div v-if="currentView === 'register'">
        <h2>Register</h2>
        <form @submit.prevent="register" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
            <input
              v-model="registerForm.username"
              type="text"
              required
              style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
            />
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
            <input
              v-model="registerForm.password"
              type="password"
              required
              style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
            />
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Confirm Password:</label>
            <input
              v-model="registerForm.password2"
              type="password"
              required
              style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
            />
          </div>
          <button
            type="submit"
            :disabled="authLoading"
            style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%;"
          >
            {{ authLoading ? 'Registering...' : 'Register' }}
          </button>
        </form>
      </div>

      <!-- Create Analysis View -->
      <div v-if="currentView === 'create' && isAuthenticated">
        <h2>Create New DIC Analysis</h2>
        <form @submit.prevent="createAnalysis" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Analysis Name:</label>
            <input
              v-model="newAnalysis.name"
              type="text"
              required
              placeholder="Enter analysis name"
              style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
            />
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Before Image:</label>
            <input
              ref="beforeImageInput"
              type="file"
              accept="image/*"
              @change="handleImageSelect('before')"
              required
              style="margin: 10px 0;"
            />
            <div v-if="newAnalysis.imageBeforePreview" style="margin-top: 10px;">
              <img :src="newAnalysis.imageBeforePreview" style="max-width: 200px; max-height: 200px; border: 1px solid #ccc; border-radius: 4px;" />
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">After Image:</label>
            <input
              ref="afterImageInput"
              type="file"
              accept="image/*"
              @change="handleImageSelect('after')"
              required
              style="margin: 10px 0;"
            />
            <div v-if="newAnalysis.imageAfterPreview" style="margin-top: 10px;">
              <img :src="newAnalysis.imageAfterPreview" style="max-width: 200px; max-height: 200px; border: 1px solid #ccc; border-radius: 4px;" />
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Subset Size (21-31, odd):</label>
            <input
              v-model.number="newAnalysis.subset_size"
              type="number"
              min="21"
              max="31"
              step="2"
              required
              style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;"
            />
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Step Size:</label>
            <input
              v-model.number="newAnalysis.step"
              type="number"
              min="1"
              required
              style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;"
            />
          </div>

          <button
            type="submit"
            :disabled="creating"
            style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;"
          >
            {{ creating ? 'Creating...' : 'Create Analysis' }}
          </button>
        </form>
      </div>

      <!-- List Analyses View -->
      <div v-if="currentView === 'list' && isAuthenticated">
        <h2>All DIC Analyses</h2>
        <div v-if="loading" style="text-align: center; padding: 20px;">
          <p>Loading analyses...</p>
        </div>
        <div v-else-if="analyses.length === 0" style="text-align: center; padding: 20px;">
          <p>No analyses found.</p>
        </div>
        <div v-else style="display: grid; gap: 15px;">
          <div v-for="analysis in analyses" :key="analysis.id" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0;">{{ analysis.name }}</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
              <div>
                <p style="margin: 5px 0; color: #666;"><strong>Status:</strong> {{ analysis.status_display }}</p>
                <p style="margin: 5px 0; color: #666;"><strong>Created:</strong> {{ new Date(analysis.created_at).toLocaleString() }}</p>
              </div>
              <div>
                <p style="margin: 5px 0; color: #666;"><strong>Subset Size:</strong> {{ analysis.subset_size }}</p>
                <p style="margin: 5px 0; color: #666;"><strong>Step:</strong> {{ analysis.step }}</p>
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button @click="viewAnalysis(analysis.id)" style="padding: 8px 16px; background: #1976D2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                View Details
              </button>
              <button v-if="analysis.status === 'completed'" @click="downloadResults(analysis.id)" style="padding: 8px 16px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Download
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Detail View -->
      <div v-if="currentView === 'detail' && isAuthenticated">
        <div v-if="!currentAnalysis" style="text-align: center; padding: 20px;">
          <p>Loading analysis details...</p>
        </div>
        <div v-else>
          <button @click="currentView = 'list'" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px;">
            ‚Üê Back to List
          </button>

          <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2>{{ currentAnalysis.name }}</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
              <div>
                <h4>Analysis Info</h4>
                <p><strong>Status:</strong> {{ currentAnalysis.status_display }}</p>
                <p><strong>Created:</strong> {{ new Date(currentAnalysis.created_at).toLocaleString() }}</p>
                <p><strong>Subset Size:</strong> {{ currentAnalysis.subset_size }}</p>
                <p><strong>Step:</strong> {{ currentAnalysis.step }}</p>
                <p v-if="currentAnalysis.error_message"><strong>Error:</strong> {{ currentAnalysis.error_message }}</p>
              </div>

              <div v-if="currentAnalysis.status === 'completed'">
                <h4>Results</h4>
                <p><strong>Processing Time:</strong> {{ currentAnalysis.processing_time }}s</p>
                <button @click="downloadResults(currentAnalysis.id)" style="padding: 8px 16px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  Download Results
                </button>
              </div>
            </div>

            <div v-if="currentAnalysis.image_before_url || currentAnalysis.image_after_url" style="margin-top: 20px;">
              <h4>Images</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div v-if="currentAnalysis.image_before_url">
                  <p><strong>Before Image:</strong></p>
                  <img :src="currentAnalysis.image_before_url" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 4px;" />
                </div>
                <div v-if="currentAnalysis.image_after_url">
                  <p><strong>After Image:</strong></p>
                  <img :src="currentAnalysis.image_after_url" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 4px;" />
                </div>
                <div v-if="currentAnalysis.displacement_map_url">
                  <p><strong>Displacement Map:</strong></p>
                  <img :src="currentAnalysis.displacement_map_url" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 4px;" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Messages -->
      <div v-if="error" style="margin: 20px 0; padding: 15px; background: #ffebee; border: 1px solid #f44336; border-radius: 4px;">
        <p style="color: #c62828; margin: 0;"><strong>Error:</strong> {{ error }}</p>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            currentView: 'list',
            loading: false,
            creating: false,
            authLoading: false,
            error: null,
            analyses: [],
            currentAnalysis: null,
            isAuthenticated: false,
            user: null,
            loginForm: {
              username: '',
              password: ''
            },
            registerForm: {
              username: '',
              password: '',
              password2: ''
            },
            newAnalysis: {
              name: '',
              subset_size: 25,
              step: 5,
              imageBefore: null,
              imageAfter: null,
              imageBeforePreview: null,
              imageAfterPreview: null
            }
          }
        },

        mounted() {
          this.getCsrfToken();
          this.checkAuth();
          if (this.isAuthenticated) {
            this.currentView = 'list';
            this.loadAnalyses();
          } else {
            this.currentView = 'login';
          }
        },

        methods: {

          getCsrfToken() {
            axios.get('http://localhost:8000/api/get-csrf-token/', { withCredentials: true })
              .then(response => {
                // CSRF token will be set automatically in cookies
              })
              .catch(error => {
                console.log('CSRF token error:', error);
              });
          },

          checkAuth() {
            const user = localStorage.getItem('user');
            const isAuth = localStorage.getItem('is_authenticated') === 'true';
            if (isAuth && user) {
              this.isAuthenticated = true;
              this.user = JSON.parse(user);
            }
          },

          login() {
            this.authLoading = true;
            this.error = null;

            axios.post('http://localhost:8000/api/auth/login/', this.loginForm, { withCredentials: true })
              .then(response => {
                const user = response.data.user;

                localStorage.setItem('user', JSON.stringify(user));
                localStorage.setItem('is_authenticated', 'true');

                this.isAuthenticated = true;
                this.user = user;
                this.currentView = 'list';
                this.loadAnalyses();

                this.loginForm = { username: '', password: '' };
              })
              .catch(error => {
                console.error('Login error:', error);
                this.error = error.response?.data?.error || 'Login failed';
              })
              .finally(() => {
                this.authLoading = false;
              });
          },

          register() {
            if (this.registerForm.password !== this.registerForm.password2) {
              this.error = 'Passwords do not match';
              return;
            }

            this.authLoading = true;
            this.error = null;

            const registerData = {
              username: this.registerForm.username,
              password: this.registerForm.password
            };
            axios.post('http://localhost:8000/api/auth/register/', registerData, { withCredentials: true })
              .then(response => {
                alert('Registration successful! Please login.');
                this.currentView = 'login';
                this.registerForm = { username: '', password: '', password2: '' };
              })
              .catch(error => {
                console.error('Register error:', error);
                this.error = error.response?.data?.error || 'Registration failed';
              })
              .finally(() => {
                this.authLoading = false;
              });
          },

          logout() {
            axios.post('http://localhost:8000/api/auth/logout/', {}, { withCredentials: true })
              .finally(() => {
                localStorage.removeItem('user');
                localStorage.removeItem('is_authenticated');

                this.isAuthenticated = false;
                this.user = null;
                this.analyses = [];
                this.currentAnalysis = null;
                this.currentView = 'login';
              });
          },

          loadAnalyses() {
            if (!this.isAuthenticated) return;

            this.loading = true;
            this.error = null;

            axios.get('http://localhost:8000/api/analyses/', { withCredentials: true })
              .then(response => {
                this.analyses = response.data.results || response.data;
              })
              .catch(error => {
                console.error('Error loading analyses:', error);
                this.error = 'Failed to load analyses';
              })
              .finally(() => {
                this.loading = false;
              });
          },

          handleImageSelect(type) {
            const input = type === 'before' ? this.$refs.beforeImageInput : this.$refs.afterImageInput;
            const file = input.files[0];

            if (file) {
              if (type === 'before') {
                this.newAnalysis.imageBefore = file;
                this.newAnalysis.imageBeforePreview = URL.createObjectURL(file);
              } else {
                this.newAnalysis.imageAfter = file;
                this.newAnalysis.imageAfterPreview = URL.createObjectURL(file);
              }
            }
          },

          createAnalysis() {
            if (!this.isAuthenticated) {
              this.error = 'Please login first';
              this.currentView = 'login';
              return;
            }

            if (!this.newAnalysis.name || !this.newAnalysis.imageBefore || !this.newAnalysis.imageAfter) {
              this.error = 'Please fill all required fields';
              return;
            }

            this.creating = true;
            this.error = null;

            const formData = new FormData();
            formData.append('name', this.newAnalysis.name);
            formData.append('image_before', this.newAnalysis.imageBefore);
            formData.append('image_after', this.newAnalysis.imageAfter);
            formData.append('subset_size', this.newAnalysis.subset_size);
            formData.append('step', this.newAnalysis.step);

            axios.post('http://localhost:8000/api/analyses/', formData, {
              headers: {
                'Content-Type': 'multipart/form-data'
              },
              withCredentials: true
            })
            .then(response => {
              alert('Analysis created successfully!');
              this.resetForm();
              this.currentView = 'list';
              this.loadAnalyses();
            })
            .catch(error => {
              console.error('Error creating analysis:', error);
              this.error = error.response?.data?.error || 'Failed to create analysis';
            })
            .finally(() => {
              this.creating = false;
            });
          },

          resetForm() {
            this.newAnalysis = {
              name: '',
              subset_size: 25,
              step: 5,
              imageBefore: null,
              imageAfter: null,
              imageBeforePreview: null,
              imageAfterPreview: null
            };

            // Clear file inputs
            if (this.$refs.beforeImageInput) this.$refs.beforeImageInput.value = '';
            if (this.$refs.afterImageInput) this.$refs.afterImageInput.value = '';
          },

          viewAnalysis(id) {
            this.loading = true;
            this.error = null;

            axios.get(`http://localhost:8000/api/analyses/${id}/`, { withCredentials: true })
              .then(response => {
                this.currentAnalysis = response.data;
                this.currentView = 'detail';
              })
              .catch(error => {
                console.error('Error loading analysis:', error);
                this.error = 'Failed to load analysis details';
              })
              .finally(() => {
                this.loading = false;
              });
          },

          downloadResults(id) {
            window.open(`http://localhost:8000/api/analyses/${id}/download/`, '_blank');
          }
        },

        watch: {
          currentView(newView) {
            if (newView === 'list' && this.isAuthenticated && this.analyses.length === 0) {
              this.loadAnalyses();
            }
            // Redirect to login if trying to access protected views without auth
            if (!this.isAuthenticated && (newView === 'create' || newView === 'list' || newView === 'detail')) {
              this.currentView = 'login';
            }
          }
        }
      }).mount('#app');
    </script>
  </body>
</html>