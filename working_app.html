<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIC Analyzer - Working Version</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/vuetify@3/dist/vuetify.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/vuetify@3/dist/vuetify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.9.55/css/materialdesignicons.min.css">
    <style>
        body { font-family: 'Roboto', sans-serif; }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-app-bar app color="primary" dark>
                <v-toolbar-title>DIC Analyzer</v-toolbar-title>
                <v-spacer></v-spacer>
                <v-btn to="/">Dashboard</v-btn>
                <v-btn to="/analyses">Analyses</v-btn>
                <v-btn to="/analyses/create" color="accent">Create Analysis</v-btn>
            </v-app-bar>

            <v-main>
                <v-container>
                    <router-view></router-view>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script>
        const { createApp } = Vue;
        const { createRouter, createWebHashHistory } = VueRouter;

        // Global CSRF token
        let csrfToken = '';

        // Initialize the app
        async function init() {
            try {
                console.log('Initializing DIC Analyzer...');
                const response = await fetch('/api/get-csrf-token/', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                const data = await response.json();
                csrfToken = data.csrfToken;
                    console.log('CSRF Token obtained successfully');
                } else {
                    console.error('Failed to get CSRF token');
                }

                // Start Vue app after CSRF token is obtained
                startVueApp();
            } catch (error) {
                console.error('Init error:', error);
                // Start Vue app anyway
                startVueApp();
            }
        }

        function startVueApp() {

        // Global functions
        function addResult(message, type = 'info') {
            console.log(`${type}: ${message}`);
            // Simple console logging for now
        }

        // Define components
        const Dashboard = {
            template: `
                <div>
                    <h1>Dashboard</h1>
                    <p>Welcome to DIC Analyzer!</p>
                    <p>This is a complete DIC analysis system with modern web interface.</p>

                    <div style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                        <h3>System Status</h3>
                        <p>CSRF Token: {{ csrfStatus }}</p>
                        <p>Backend API: Connected</p>
                        <p>Database: PostgreSQL Ready</p>
                    </div>
                </div>
            `,
            data() {
                return {
                    csrfStatus: csrfToken ? 'Available' : 'Not available'
                }
            }
        };

        const AnalysesList = {
            template: `
                <div>
                    <h1>Analyses List</h1>
                    <p>Here you can view all analyses.</p>
                    <v-btn @click="loadAnalyses" color="primary">Refresh List</v-btn>
                    <div v-if="analyses.length === 0" class="mt-4">
                        <p>No completed analyses found</p>
                    </div>
                    <div v-else class="mt-4">
                        <v-card v-for="analysis in analyses" :key="analysis.id" class="mb-3">
                            <v-card-title>{{ analysis.name }}</v-card-title>
                            <v-card-text>
                                <p><strong>ID:</strong> {{ analysis.id }}</p>
                                <p><strong>Status:</strong> {{ analysis.status_display }}</p>
                                <p><strong>Created:</strong> {{ new Date(analysis.created_at).toLocaleString() }}</p>
                                <p v-if="analysis.sample_name"><strong>Sample:</strong> {{ analysis.sample_name }}</p>
                                <p v-if="analysis.material"><strong>Material:</strong> {{ analysis.material }}</p>
                                <p v-if="analysis.manufacture"><strong>Manufacturer:</strong> {{ analysis.manufacture }}</p>
                                <p v-if="analysis.test_date"><strong>Test Date:</strong> {{ new Date(analysis.test_date).toLocaleDateString('ru-RU') }}</p>
                            </v-card-text>
                            <v-card-actions>
                                <v-btn v-if="analysis.status === 'completed'" @click="downloadAnalysis(analysis.id)" color="primary">
                                    üì• Download Results
                                </v-btn>
                                <v-btn v-if="analysis.status === 'processing'" @click="cancelAnalysis(analysis.id)" color="error">
                                    ‚ùå Cancel
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </div>
                </div>
            `,
            data() {
                return {
                    analyses: []
                }
            },
            methods: {
                async loadAnalyses() {
                    try {
                        const response = await fetch('/api/analyses/?page_size=1000', {
                            credentials: 'include'
                        });
                        const data = await response.json();
                        if (response.ok) {
                            this.analyses = data.results.filter(analysis =>
                                analysis.status === 'completed' || analysis.status_display === '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
                            );
                        }
                    } catch (error) {
                        console.error('Load analyses error:', error);
                    }
                },
                async cancelAnalysis(analysisId) {
                    if (!confirm('Are you sure you want to cancel this analysis?')) return;
                    try {
                        const response = await fetch(`/api/analyses/${analysisId}/cancel/`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                        if (response.ok) {
                            this.loadAnalyses();
                        }
                    } catch (error) {
                        console.error('Cancel error:', error);
                    }
                },
                downloadAnalysis(analysisId) {
                    window.open(`/api/analyses/${analysisId}/download/`, '_blank');
                }
            },
            mounted() {
                this.loadAnalyses();
            }
        };

        const AnalysisCreate = {
            template: `
                <div>
                    <h1>Create New Analysis</h1>
                    <v-form>
                        <v-text-field
                            v-model="form.name"
                            label="Analysis Name"
                            placeholder="Enter analysis name"
                            required
                            class="mb-4"
                        />

                        <h3 class="mb-4">Sample Information</h3>
                        <v-row>
                            <v-col cols="12" md="6">
                                <v-text-field
                                    v-model="form.sample_name"
                                    label="Sample Name"
                                    placeholder="Enter sample name"
                                />
                            </v-col>
                            <v-col cols="12" md="6">
                                <v-text-field
                                    v-model="form.material"
                                    label="Material"
                                    placeholder="Enter material type"
                                />
                            </v-col>
                            <v-col cols="12" md="6">
                                <v-text-field
                                    v-model="form.manufacture"
                                    label="Manufacturer"
                                    placeholder="Enter manufacturer"
                                />
                            </v-col>
                            <v-col cols="12" md="6">
                                <v-text-field
                                    v-model="form.test_date"
                                    label="Test Date"
                                    type="date"
                                />
                            </v-col>
                        </v-row>

                        <h3 class="mb-4 mt-6">Images</h3>
                        <v-row>
                            <v-col cols="12" md="6">
                                <v-file-input
                                    v-model="form.image_before"
                                    label="Before Image (Reference)"
                                    accept="image/*"
                                    required
                                    show-size
                                />
                            </v-col>
                            <v-col cols="12" md="6">
                                <v-file-input
                                    v-model="form.image_after"
                                    label="After Image (Deformed)"
                                    accept="image/*"
                                    required
                                    show-size
                                />
                            </v-col>
                        </v-row>

                        <h3 class="mb-4 mt-6">Analysis Parameters</h3>
                        <v-row>
                            <v-col cols="12" md="4">
                                <v-text-field
                                    v-model.number="form.subset_size"
                                    label="Subset Size"
                                    type="number"
                                    :rules="[v => v >= 21 && v <= 31 || 'Must be between 21-31']"
                                />
                            </v-col>
                            <v-col cols="12" md="4">
                                <v-text-field
                                    v-model.number="form.step"
                                    label="Step Size"
                                    type="number"
                                    :rules="[v => v > 0 || 'Must be positive']"
                                />
                            </v-col>
                            <v-col cols="12" md="4">
                                <v-text-field
                                    v-model.number="form.max_iter"
                                    label="Max Iterations"
                                    type="number"
                                    :rules="[v => v > 0 || 'Must be positive']"
                                />
                            </v-col>
                            <v-col cols="12" md="4">
                                <v-text-field
                                    v-model.number="form.min_correlation"
                                    label="Min Correlation"
                                    type="number"
                                    step="0.01"
                                    :rules="[v => v >= 0 && v <= 1 || 'Must be between 0-1']"
                                />
                            </v-col>
                        </v-row>

                        <v-btn
                            color="primary"
                            size="large"
                            @click="submitForm"
                            :loading="loading"
                            :disabled="!isValid"
                            class="mt-6"
                        >
                            üöÄ Start Analysis
                        </v-btn>
                    </v-form>
                </div>
            `,
            data() {
                return {
                    loading: false,
                    form: {
                        name: 'DIC Analysis',
                        sample_name: '',
                        material: '',
                        manufacture: '',
                        test_date: '',
                        image_before: null,
                        image_after: null,
                        subset_size: 25,
                        step: 12,
                        max_iter: 35,
                        min_correlation: 0.4
                    }
                }
            },
            computed: {
                isValid() {
                    return this.form.name &&
                           this.form.image_before &&
                           this.form.image_after &&
                           this.form.subset_size >= 21 && this.form.subset_size <= 31 &&
                           this.form.step > 0 &&
                           this.form.max_iter > 0 &&
                           this.form.min_correlation >= 0 && this.form.min_correlation <= 1;
                }
            },
            methods: {
                async submitForm() {
                    if (!this.isValid) return;

                    this.loading = true;
            const formData = new FormData();

            // Add text fields
                    formData.append('name', this.form.name);
                    if (this.form.sample_name) formData.append('sample_name', this.form.sample_name);
                    if (this.form.material) formData.append('material', this.form.material);
                    if (this.form.manufacture) formData.append('manufacture', this.form.manufacture);
                    if (this.form.test_date) formData.append('test_date', this.form.test_date);

                    formData.append('subset_size', this.form.subset_size.toString());
                    formData.append('step', this.form.step.toString());
                    formData.append('max_iter', this.form.max_iter.toString());
                    formData.append('min_correlation', this.form.min_correlation.toString());

            // Add CSRF token
                    if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
                    }

            // Add files
                    formData.append('image_before', this.form.image_before);
                    formData.append('image_after', this.form.image_after);

                    try {
                        const response = await fetch('/api/analyses/', {
                    method: 'POST',
                            credentials: 'include',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });

                if (response.ok) {
                            alert('Analysis created successfully!');
                            this.$router.push('/analyses');
                } else {
                            const error = await response.text();
                            alert('Error: ' + error);
                }
            } catch (error) {
                        alert('Error: ' + error.message);
                    }

                    this.loading = false;
                }
            }
        };

        // Define components
        const AuthComponent = {
            template: `
                <div>
                    <h1>User Authentication</h1>

                    <v-tabs v-model="tab" class="mb-4">
                        <v-tab>Login</v-tab>
                        <v-tab>Register</v-tab>
                    </v-tabs>

                    <v-window v-model="tab">
                        <!-- Login Tab -->
                        <v-window-item>
                            <v-card class="pa-4">
                                <v-card-title>Login</v-card-title>
                                <v-card-text>
                                    <v-text-field
                                        v-model="loginForm.username"
                                        label="Username"
                                        required
                                        class="mb-2"
                                    />
                                    <v-text-field
                                        v-model="loginForm.password"
                                        label="Password"
                                        type="password"
                                        required
                                        class="mb-4"
                                    />
                                    <v-btn
                                        color="primary"
                                        @click="login"
                                        :loading="loading"
                                        :disabled="!loginForm.username || !loginForm.password"
                                    >
                                        Login
                                    </v-btn>
                                </v-card-text>
                            </v-card>
                        </v-window-item>

                        <!-- Register Tab -->
                        <v-window-item>
                            <v-card class="pa-4">
                                <v-card-title>Register</v-card-title>
                                <v-card-text>
                                    <v-text-field
                                        v-model="registerForm.username"
                                        label="Username"
                                        required
                                        class="mb-2"
                                    />
                                    <v-text-field
                                        v-model="registerForm.password"
                                        label="Password"
                                        type="password"
                                        required
                                        class="mb-4"
                                    />
                                    <v-btn
                                        color="primary"
                                        @click="register"
                                        :loading="loading"
                                        :disabled="!registerForm.username || !registerForm.password"
                                    >
                                        Register
                                    </v-btn>
                                </v-card-text>
                            </v-card>
                        </v-window-item>
                    </v-window>

                    <div v-if="message" class="mt-4">
                        <v-alert :type="messageType">{{ message }}</v-alert>
                    </div>
                </div>
            `,
            data() {
                return {
                    tab: 0,
                    loading: false,
                    message: '',
                    messageType: 'info',
                    loginForm: {
                        username: '',
                        password: ''
                    },
                    registerForm: {
                        username: '',
                        password: ''
                    }
                }
            },
            methods: {
                async login() {
                    this.loading = true;
                    this.message = '';

                    try {
                        const response = await fetch('/api/auth/login/', {
                    method: 'POST',
                            credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                    },
                            body: JSON.stringify(this.loginForm)
                });

                const data = await response.json();

                if (response.ok) {
                            this.message = 'Login successful!';
                            this.messageType = 'success';
                            // Redirect to dashboard after successful login
                            setTimeout(() => {
                                this.$router.push('/');
                            }, 1000);
                } else {
                            this.message = data.error || 'Login failed';
                            this.messageType = 'error';
                }
            } catch (error) {
                        this.message = 'Network error: ' + error.message;
                        this.messageType = 'error';
                    }

                    this.loading = false;
                },

                async register() {
                    this.loading = true;
                    this.message = '';

                    try {
                        const response = await fetch('/api/auth/register/', {
                    method: 'POST',
                            credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                    },
                            body: JSON.stringify(this.registerForm)
                });

                const data = await response.json();

                if (response.ok) {
                            this.message = 'Registration successful!';
                            this.messageType = 'success';
                            // Switch to login tab after successful registration
                            setTimeout(() => {
                                this.tab = 0;
                                this.message = '';
                            }, 2000);
                } else {
                            this.message = data.error || 'Registration failed';
                            this.messageType = 'error';
                }
            } catch (error) {
                        this.message = 'Network error: ' + error.message;
                        this.messageType = 'error';
                    }

                    this.loading = false;
                }
            }
        };

        // Define routes
        const routes = [
            { path: '/', component: Dashboard },
            { path: '/auth', component: AuthComponent },
            { path: '/analyses', component: AnalysesList },
            { path: '/analyses/create', component: AnalysisCreate }
        ];

        // Create router
        const router = createRouter({
            history: createWebHashHistory(),
            routes
        });

        // Create Vuetify instance
        const vuetify = Vuetify.createVuetify({
            theme: {
                defaultTheme: 'light'
            }
        });

        // Create and mount app
        const app = createApp({
            template: `
                <v-app>
                    <v-app-bar app color="primary" dark>
                        <v-toolbar-title>DIC Analyzer</v-toolbar-title>
                        <v-spacer></v-spacer>
                        <v-btn to="/">Dashboard</v-btn>
                        <v-btn to="/analyses">Analyses</v-btn>
                        <v-btn to="/analyses/create" color="accent">Create Analysis</v-btn>
                        <v-btn to="/auth" variant="outlined">Login/Register</v-btn>
                    </v-app-bar>

                    <v-main>
                        <v-container>
                            <router-view></router-view>
                        </v-container>
                    </v-main>
                </v-app>
            `
        });

        app.use(router);
        app.use(vuetify);
        app.mount('#app');

        console.log('DIC Analyzer Vue app loaded successfully!');
        }

        // Start initialization
        init();
    </script>
</body>
</html>
